<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Backup Operators Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* === LOGO STYLES === */
.logo-container {
    text-align: center;
    margin-bottom: 10px;
}
.logo-container img {
    max-width: 150px;
    height: auto;
    border-radius: 5px;
}
/* === End Logo Styles === */

/* === NEXT SHIFTS SLIDER STYLES (DIMLIGHTED) === */
#nextShiftsWrapper {
    margin: 0 auto 20px auto;
    max-width: 1000px;
}
#nextShiftsContainer {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding: 10px 0;
    white-space: nowrap;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #c9c9c9;
    border-radius: 6px;
    background-color: #f0f0f0;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.shift-card {
    flex: 0 0 200px;
    padding: 10px 15px;
    background-color: #E7E8EA;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    border-left: 5px solid #00A8E8;
    transition: transform 0.2s;
}
.shift-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.shift-card-header {
    font-weight: bold;
    font-size: 1.1em;
    color: #444;
    margin-bottom: 5px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.shift-card p {
    margin: 2px 0;
    font-size: 0.9em;
    color: #555;
}
.shift-card .date-range {
    font-weight: bold;
    color: #4D8BCA;
}
/* === End Next Shifts Slider Styles === */


/* === Color Palette and General Styles === */
body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #ABB8C3;
}
h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
}

/* Top Section */
.top-section {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
.top-section label {
    font-weight: bold;
}
.top-section input[type="date"], .top-section select {
    padding: 6px 10px;
    font-size: 14px;
    border: 1px solid #999;
    border-radius: 4px;
}
.top-section button {
    padding: 8px 14px;
    font-size: 14px;
    background-color: #94C83D;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.top-section button:hover {
    background-color: #7DAE2F;
}

/* Authentication */
#authSection {
    text-align: center;
    margin-bottom: 20px;
}
#authSection input, #authSection button {
    padding: 6px 10px;
    font-size: 14px;
    margin: 5px;
    border-radius: 4px;
    border: none;
}
#authSection button {
    background-color: #4D8BCA;
    color: white;
    cursor: pointer;
}
#authSection button:hover {
    background-color: #386B99;
}

/* Controls */
.controls {
    text-align: center;
    margin-bottom: 20px;
}
.controls h3 {
    margin-top: 15px;
    margin-bottom: 10px;
}
.controls input, .controls button {
    padding: 6px 10px;
    font-size: 15px;
    margin-right: 10px;
    border-radius: 4px;
    border: none;
}
.controls button {
    background-color: #94C83D;
    color: white;
    cursor: pointer;
}
.controls button:hover {
    background-color: #7DAE2F;
}
#logoutBtn {
    background-color: #cc0000;
}
#logoutBtn:hover {
    background-color: #a30000;
}
/* New Button Style for clarity */
#resetMyPwdBtn {
    background-color: #FF5733; /* A distinct, action-oriented color */
}
#resetMyPwdBtn:hover {
    background-color: #C70039;
}

/* Shift Calculator */
#shiftCalculator {
    margin: 20px auto;
    padding: 15px;
    background-color: #e6f3ff;
    border: 1px solid #a8d5ff;
    border-radius: 5px;
    max-width: 500px;
    text-align: left;
}
#shiftCalculator label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
}
#shiftCalculator input[type="date"] {
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 10px;
}
#shiftCalculator .result {
    margin-top: 10px;
    font-size: 1.1em;
    font-weight: bold;
    color: #007bff;
}

/* Table */
.table-container {
    width: 100%;
    overflow-x: auto;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}
th, td {
    border: 1px solid #999;
    padding: 10px;
    text-align: left;
    font-size: 14px;
    white-space: nowrap;
}
th {
    background-color: #94C83D;
    color: white;
    text-align: center;
}
/* Ensure highlights override zebra striping */
tr:not(.highlight-today):not(.highlight-next):nth-child(even) { background-color: #F0F0F0; }
tr:not(.highlight-today):not(.highlight-next):nth-child(odd) { background-color: #E7E8EA; }
tbody tr {
    cursor: pointer;
}

/* === Highlighting Styles === */
.highlight-today {
    background-color: #FFEA00 !important;
    font-weight: bold;
}
.highlight-next {
    background-color: #C8FFC8 !important;
}


/* Footer */
.note {
    text-align: center;
    background-color: #94C83D;
    color: white;
    font-weight: bold;
    padding: 12px;
    font-size: 16px;
    border-radius: 5px;
    margin-top: 15px;
}
.footer {
    text-align: center;
    font-size: 13px;
    color: #FFFFFF;
    background-color: #00A8E8;
    font-style: italic;
    margin-top: 20px;
    padding: 10px 0;
    border-radius: 5px;
}

/* Action Buttons (Visible only to Full Admin) */
.rename-btn, .reset-btn, .delete-btn, .swap-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    margin: 2px;
    font-size: 13px;
}
.rename-btn { background-color: #888A8C; color: #fff; }
.rename-btn:hover { background-color: #6E7072; }
.reset-btn { background-color: #17a2b8; color: #fff; }
.reset-btn:hover { background-color: #117a8b; }
.delete-btn { background-color: #cc0000; color: #fff; }
.delete-btn:hover { background-color: #ff4444; }
.swap-btn { background-color: #00A8E8; color: #fff; } /* NEW SWAP BUTTON STYLE */
.swap-btn:hover { background-color: #0087b8; }


/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}
.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 25px;
    border: 1px solid #888;
    width: 80%;
    max-width: 450px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}
.close:hover, .close:focus {
    color: #000;
    cursor: pointer;
}
.modal-content label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
}
.modal-content input, .modal-content select {
    width: 95%;
    padding: 8px;
    margin: 5px 0 15px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box; /* Crucial for input/select sizing */
}
.modal-content button {
    padding: 8px 15px;
    margin-right: 10px;
}

/* Responsive */
@media(max-width:600px){
    th, td { font-size: 13px; padding: 8px; }
    .top-section { flex-direction: column; align-items: stretch; }
    .controls, #authSection {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .controls input, .controls button, #authSection input, #authSection button {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
    }
    .modal-content {
        margin: 5% auto;
        width: 90%;
    }
    .shift-card {
        flex: 0 0 160px;
        padding: 8px 12px;
    }
}
</style>
</head>
<body>

<div class="logo-container">
    <img src="oromia bank.png" alt="Oromia Bank">
</div>

<h2>Backup Operators Schedule</h2>

<div id="nextShiftsWrapper">
    <div id="nextShiftsContainer">
        </div>
</div>

<div class="top-section">
    <label for="startDate">Schedule Start Date:</label>
    <input type="date" id="startDate" onchange="generateScheduleByDate(this.value)">
    <button id="downloadPdfBtn" onclick="downloadPdf()" style="display:none;">Download PDF</button>

    <label for="operatorFilter" id="filterLabel" style="display:none;">View Schedule:</label>
    <select id="operatorFilter" onchange="renderTable()" style="display:none;">
        <option value="">-- All Operators --</option>
    </select>
    
    <button onclick="resetMyPassword()" id="resetMyPwdBtn" style="display:none;">Reset My Password</button>

    <button onclick="openChangePasswordModal()" id="changePwdBtn" style="display:none;">Set New Password</button>

    <button onclick="logout()" id="logoutBtn" style="display:none;">Logout</button>
    <button onclick="scrollToAdd()" id="adminActionsBtn">Admin Actions</button>
</div>

<div id="authSection">
    <input type="text" id="loginUsername" placeholder="Enter username (e.g., admin, view, or Your Name)">
    <input type="password" id="adminPassword" placeholder="Enter password">
    <button onclick="authenticate()">Login</button>
</div>

<div class="controls" id="adminControls" style="display:none;">
    <h3>Full Admin Controls </h3>
    <input type="text" id="operatorName" placeholder="Operator Name">
    <input type="text" id="mobileNumber" placeholder="Mobile Number">
    <button onclick="addOperator()">Add Operator</button>
    <button onclick="generateScheduleButton()">Generate Full Schedule</button>
    <button onclick="resetAll()">Clear ALL Data</button>

    <div id="shiftCalculator">
        <h3>Shift Range Calculator (10 Working Days, No Sundays)</h3>
        <label for="calcStartDate">Enter Shift Start Date:</label>
        <input type="date" id="calcStartDate" onchange="calculateShiftRange()">
        <div class="result">Shift End Date: <span id="calcEndDate">--</span></div>
        <div class="result">Total Working Days: <span id="calcWorkingDays">--</span></div>
    </div>
</div>

<div class="table-container" id="scheduleView" style="display:none;">
    <table id="scheduleTable">
        <thead>
            <tr>
                <th>S/N</th>
                <th>Taken by</th>
                <th>Checked by</th>
                <th>Mobile number</th>
                <th>Date Range</th>
                <th id="actionsHeader">Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="note">BACKUP OPERATORS SCHEDULE</div>

<div class="footer">Â© 2025 Backup Operators Schedule | All rights reserved | Developed by HAMBISA ADAMU.</div>

<div id="renameModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeRenameModal()">&times;</span>
        <h3>Rename Operator</h3>
        <label for="newName">New Name:</label>
        <input type="text" id="newName">
        <button onclick="confirmRename()">Rename</button>
        <button onclick="closeRenameModal()">Cancel</button>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDetailModal()">&times;</span>
        <h3>Schedule Details</h3>
        <p><strong>Operator:</strong> <span id="detailOperatorName"></span></p>
        <p><strong>Mobile:</strong> <span id="detailMobile"></span></p>
        <p><strong>Shift Start:</strong> <span id="detailStart"></span></p>
        <p><strong>Shift End:</strong> <span id="detailEnd"></span></p>
        <p><strong>Working Days:</strong> <span id="detailWorkingDays"></span></p>
    </div>
</div>

<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeChangePasswordModal()">&times;</span>
        <h3>Set New Password</h3>
        <label for="newOpPassword">New Password:</label>
        <input type="password" id="newOpPassword" placeholder="Enter new password">
        <label for="confirmOpPassword">Confirm Password:</label>
        <input type="password" id="confirmOpPassword" placeholder="Confirm new password">
        <button onclick="confirmPasswordChange()">Change Password</button>
    </div>
</div>

<div id="swapModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSwapModal()">&times;</span>
        <h3>Swap Shift Responsibility</h3>
        <p>You are about to reassign the shift starting: <strong id="swapShiftStart"></strong></p>
        <p>Currently assigned to: <strong id="swapCurrentOperator"></strong></p>
        <label for="newOperatorSelect">Select New Operator:</label>
        <select id="newOperatorSelect">
            </select>
        <button onclick="confirmSwap()">Confirm Swap</button>
        <button onclick="closeSwapModal()">Cancel</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

<script>
// --- HARDCODED OPERATOR LIST (Initial Data) ---
const INITIAL_OPERATORS_DATA_KEY = 'initialOperators';
let initialOperators = JSON.parse(localStorage.getItem(INITIAL_OPERATORS_DATA_KEY)) || [
    { name: "ABRAHAM CHALA", mobile: "0913564114" },
    { name: "BERISO SHIBIRU", mobile: "0902911411" },
    { name: "HAMBISA ADAMU", mobile: "0913456466" } ,
    { name: "DAME TERFASSA", mobile: "0911117524" },
    { name: "TSION GIRMA", mobile: "0946700418" }
];
// -----------------------------------------------------

let operators = JSON.parse(localStorage.getItem('operators') || '[]');
let operatorPasswords = JSON.parse(localStorage.getItem('operatorPasswords') || '{}');

let isAdmin = false; 
let isRestrictedAdmin = false;
let isOperator = false;
let loggedInUser = null; 
let renameIndex = null;
let renameTargetGlobalIndex = null;
let swapTargetGlobalIndex = null; // For Shift Swap

// --- Usernames and Passwords ---
const FULL_ADMIN_USER = 'admin';
const FULL_ADMIN_PWD = 'Admin@1234!@#$';

const RESTRICTED_ADMIN_PWD = 'view123'; 
const RESTRICTED_ADMIN_USER = 'view'; 
const DEFAULT_OPERATOR_PWD = 'op123'; 

const SHIFT_LENGTH = 10; // 10 working days

// Set the date for current highlight based on the current system time.
const today = getCleanDate(new Date()); 
// Set the default schedule start date as requested (shifts begin on the day *after* this date)
const DEFAULT_SCHEDULE_START_DATE = '2025-10-08'; 

// --- Core Helper Functions ---

/** Cleans a date string or object to midnight UTC, ensuring reliable comparison. */
function getCleanDate(dateInput) {
    const d = new Date(dateInput);
    if (isNaN(d.getTime())) return new Date(NaN); 
    d.setHours(0, 0, 0, 0);
    return d;
}

/** Formats a date string for display. */
function formatDate(date) {
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const d = new Date(date);
    return isNaN(d) ? 'Invalid Date' : d.toLocaleDateString('en-US', options);
}

/** Calculates the end date by counting exactly 10 working days (excluding Sundays), starting from the provided startDate (inclusive). */
function calculateEndDate(startDate) {
    let workingDays = 0;
    let current = getCleanDate(startDate);
    
    while (workingDays < SHIFT_LENGTH) {
        if (current.getDay() !== 0) { // 0 = Sunday
            workingDays++; 
        }
        
        if (workingDays < SHIFT_LENGTH) { 
            current.setDate(current.getDate() + 1);
        }
    }
    return current;
}

function countWorkingDays(startDate, endDate) {
    let count = 0;
    let current = getCleanDate(startDate);
    const end = getCleanDate(endDate);
    
    while (current.getTime() <= end.getTime()) {
        if (current.getDay() !== 0) { // 0 = Sunday
            count++;
        }
        current.setDate(current.getDate() + 1);
    }
    return count;
}

// --- Schedule Generation and Initialization ---

/** Core function to generate the schedule. The first shift starts the day *after* officialStartDate. */
function generateFullSchedule(officialStartDate) {
    if (initialOperators.length === 0) {
          operators = [];
          localStorage.setItem('operators', JSON.stringify(operators));
          return;
    }

    let scheduleInputDate = getCleanDate(officialStartDate || DEFAULT_SCHEDULE_START_DATE);

    const uniqueOperators = initialOperators.map(op => ({ 
        name: op.name, 
        mobile: op.mobile 
    }));

    // Target End Date: One year from the scheduleInputDate
    const targetEnd = new Date(scheduleInputDate);
    targetEnd.setFullYear(targetEnd.getFullYear() + 1);
    targetEnd.setDate(targetEnd.getDate() - 1); 
    targetEnd.setHours(0,0,0,0);

    operators = [];
    
    let opIndex = 0;
    // The FIRST shift START DATE is the day AFTER the officialStartDate (e.g., 2025-10-09)
    let nextShiftStart = new Date(scheduleInputDate);
    nextShiftStart.setDate(nextShiftStart.getDate() + 1);
    nextShiftStart.setHours(0, 0, 0, 0);
    
    // Generate shifts for approximately one year (max 500 shifts for safety)
    while (nextShiftStart.getTime() <= targetEnd.getTime() && operators.length < 500) { 
        const opDetails = uniqueOperators[opIndex];
        
        const shiftStart = new Date(nextShiftStart);
        const shiftEnd = calculateEndDate(shiftStart);
        shiftEnd.setHours(0, 0, 0, 0); 
        
        if (shiftStart.getTime() <= targetEnd.getTime()) {
              const newShift = {
                  name: opDetails.name,
                  checkedBy: opDetails.name, 
                  mobile: opDetails.mobile,
                  start: shiftStart.toISOString().split('T')[0],
                  end: shiftEnd.toISOString().split('T')[0]
              };
              operators.push(newShift);
        } else {
            break; 
        }

        // Prepare for the next shift: Start the day after the current shift ends.
        nextShiftStart = new Date(shiftEnd);
        nextShiftStart.setDate(nextShiftStart.getDate() + 1);
        nextShiftStart.setHours(0, 0, 0, 0);
        
        // --- CORE ROTATION LOGIC ---
        opIndex = (opIndex + 1) % uniqueOperators.length;
    }
    
    localStorage.setItem('operators', JSON.stringify(operators));
}

function generateScheduleByDate(dateString) {
    if (!dateString) return;
    
    generateFullSchedule(dateString);
    
    renderTable();
    renderNextShifts(); 
}

function generateScheduleButton() {
    if (!isAdmin) return alert('Full Admin privileges required to generate the schedule.');
    const startDate = document.getElementById('startDate').value;
    if (!startDate) return alert('Please set the Schedule Start Date at the top.');
    
    generateFullSchedule(startDate);
    renderTable();
    renderNextShifts(); 
    alert("One-year schedule successfully generated!");
}

/* Populate Filter Dropdown */
function populateFilter() {
    const filter = document.getElementById('operatorFilter');
    const uniqueNames = [...new Set(initialOperators.map(op => op.name).filter(n => n))]; 
    const currentSelection = filter.value;
    filter.innerHTML = '<option value="">-- All Operators --</option>';

    uniqueNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        if (name === currentSelection) {
            option.selected = true;
        }
        filter.appendChild(option);
    });
}

// --- Authentication and UI Control ---

function authenticate() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('adminPassword').value.trim();
    
    // Clear previous state
    isAdmin = false;
    isRestrictedAdmin = false;
    isOperator = false;
    loggedInUser = null;

    const normalizedUsername = username.toUpperCase();

    // 1. Check Full Admin
    if (username === FULL_ADMIN_USER && password === FULL_ADMIN_PWD) {
        isAdmin = true;
        loggedInUser = username;
    } 
    // 2. Check Restricted Admin (View)
    else if (username === RESTRICTED_ADMIN_USER && password === RESTRICTED_ADMIN_PWD) {
        isRestrictedAdmin = true;
        loggedInUser = username;
    }
    // 3. Check Regular Operator
    else if (operatorPasswords[normalizedUsername] && operatorPasswords[normalizedUsername] === password) {
        isOperator = true;
        loggedInUser = normalizedUsername;
    }
    
    if (loggedInUser) {
        // Successful Login
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('scheduleView').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        document.getElementById('filterLabel').style.display = 'inline-block';
        document.getElementById('operatorFilter').style.display = 'inline-block';
        document.getElementById('changePwdBtn').style.display = 'inline-block';

        // Show password reset button only for operators
        document.getElementById('resetMyPwdBtn').style.display = isOperator ? 'inline-block' : 'none';
        
        // Admin Controls
        document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('adminActionsBtn').style.display = isAdmin ? 'inline-block' : 'none';

        if (isOperator) {
            document.getElementById('operatorFilter').value = loggedInUser;
        } else {
             document.getElementById('operatorFilter').value = '';
        }

        renderTable();
        // ðŸŒŸ MODIFIED WELCOME MESSAGE ðŸŒŸ
        alert("Welcome to Oromia Bank Backup Operators Schedule");
    } else {
        alert('Authentication failed. Check your username and password.');
        document.getElementById('adminPassword').value = '';
    }
}

function logout() {
    isAdmin = false;
    isRestrictedAdmin = false;
    isOperator = false;
    loggedInUser = null;

    document.getElementById('authSection').style.display = 'block';
    document.getElementById('scheduleView').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('downloadPdfBtn').style.display = 'none';
    document.getElementById('filterLabel').style.display = 'none';
    document.getElementById('operatorFilter').style.display = 'none';
    document.getElementById('changePwdBtn').style.display = 'none';
    document.getElementById('resetMyPwdBtn').style.display = 'none'; 
    document.getElementById('adminControls').style.display = 'none';
    document.getElementById('adminActionsBtn').style.display = 'inline-block';
    
    document.getElementById('loginUsername').value = '';
    document.getElementById('adminPassword').value = '';
    
    document.querySelector('#scheduleTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;">Please login to view the schedule.</td></tr>';
    renderNextShifts();
    alert('Logged out successfully.');
}

function init() {
    // 1. Initialize data (passwords, initial operators list)
    let passwordUpdated = false;
    initialOperators.forEach(op => {
        if (!operatorPasswords[op.name]) {
            operatorPasswords[op.name] = DEFAULT_OPERATOR_PWD; 
            passwordUpdated = true;
        }
    });
    if (passwordUpdated) {
        localStorage.setItem('operatorPasswords', JSON.stringify(operatorPasswords));
    }
    localStorage.setItem(INITIAL_OPERATORS_DATA_KEY, JSON.stringify(initialOperators));
    
    // 2. Set default start date in the input field
    document.getElementById('startDate').value = DEFAULT_SCHEDULE_START_DATE;
    
    // 3. Generate initial schedule (shifts start from 2025-10-09)
    generateFullSchedule(DEFAULT_SCHEDULE_START_DATE);
    
    // 4. Render initial view (which will be the login message)
    renderTable(); 
    renderNextShifts();
    
    // 5. Hide controls until login
    document.getElementById('scheduleView').style.display = 'none';
    document.getElementById('adminControls').style.display = 'none';
    document.getElementById('downloadPdfBtn').style.display = 'none';
    document.getElementById('filterLabel').style.display = 'none';
    document.getElementById('operatorFilter').style.display = 'none';
    document.getElementById('changePwdBtn').style.display = 'none';
    document.getElementById('resetMyPwdBtn').style.display = 'none'; 
}

// --- Main Render Function ---

function renderTable() {
    const tbody = document.querySelector('#scheduleTable tbody');
    tbody.innerHTML = '';
    
    if (!loggedInUser) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Please login to view the schedule.</td></tr>';
        return;
    }
    
    let baseOperators = operators;
    const selectedOperator = document.getElementById('operatorFilter').value;

    if (isOperator) {
        baseOperators = operators.filter(op => op.name === loggedInUser);
    } else if (selectedOperator) {
        baseOperators = operators.filter(op => op.name === selectedOperator);  
    }
    
    let filteredOperators = baseOperators;
    const isTodayFilterActive = !isOperator && !selectedOperator;
    
    let activeShiftIndexInFilteredList = -1;
    let nextShiftIndexInFilteredList = -1;
    
    if (isTodayFilterActive) {  
        const activeShiftGlobalIndex = operators.findIndex(op => {
            const opStart = getCleanDate(op.start);
            const opEnd = getCleanDate(op.end);
            return (today.getTime() >= opStart.getTime() && today.getTime() <= opEnd.getTime());
        });
        
        if (activeShiftGlobalIndex !== -1) {
            filteredOperators = operators.slice(activeShiftGlobalIndex, activeShiftGlobalIndex + 6);
            activeShiftIndexInFilteredList = 0;  
            nextShiftIndexInFilteredList = 1;
        } else {
            const upcomingShiftGlobalIndex = operators.findIndex(op => getCleanDate(op.start).getTime() > today.getTime());
            if (upcomingShiftGlobalIndex !== -1) {
                filteredOperators = operators.slice(upcomingShiftGlobalIndex, upcomingShiftGlobalIndex + 6);
                nextShiftIndexInFilteredList = 0;  
            }
        }
    } else {
        filteredOperators = baseOperators;
        
        activeShiftIndexInFilteredList = filteredOperators.findIndex(op => {
            const opStart = getCleanDate(op.start);
            const opEnd = getCleanDate(op.end);
            return (today.getTime() >= opStart.getTime() && today.getTime() <= opEnd.getTime());
        });
        
        if (activeShiftIndexInFilteredList !== -1) {
              nextShiftIndexInFilteredList = activeShiftIndexInFilteredList + 1;
              if (nextShiftIndexInFilteredList >= filteredOperators.length) nextShiftIndexInFilteredList = -1;
        } else {
              nextShiftIndexInFilteredList = filteredOperators.findIndex(op => getCleanDate(op.start).getTime() > today.getTime());
        }
    }
    
    const actionsHeader = document.getElementById('actionsHeader');
    actionsHeader.style.display = isAdmin ? 'table-cell' : 'none';

    filteredOperators.forEach((op, index) => {
        const tr = document.createElement('tr');
        tr.onclick = () => showDetailModal(op);

        let highlightClass = '';
        if (index === activeShiftIndexInFilteredList) {
            highlightClass = 'highlight-today';
        } else if (index === nextShiftIndexInFilteredList) {
            highlightClass = 'highlight-next';
        }

        tr.className = highlightClass;
        
        let serialNumber = index + 1;
        // Logic to get the S/N from the initial list, only for unfiltered views
        if (!isOperator && !selectedOperator && !isTodayFilterActive) {
            const initialOperatorIndex = initialOperators.findIndex(initialOp => initialOp.name === op.name);
            serialNumber = initialOperatorIndex !== -1 ? initialOperatorIndex + 1 : '-'; 
        }

        const globalIndex = operators.findIndex(o => o.start === op.start && o.name === op.name); 
        const actionsCell = isAdmin ? 
            `<td>
                 <button class="rename-btn" onclick="event.stopPropagation(); openRenameModal(${globalIndex})">Rename</button>
                 <button class="reset-btn" onclick="event.stopPropagation(); resetOperatorPassword(${globalIndex})">Reset</button>
                 <button class="delete-btn" onclick="event.stopPropagation(); deleteOperatorShift(${globalIndex})">Delete</button>
                 <button class="swap-btn" onclick="event.stopPropagation(); openSwapModal(${globalIndex})">Swap</button>
             </td>` : 
            `<td style="display:none;">â€”</td>`;
            
        tr.innerHTML = `
            <td>${serialNumber}</td>
            <td>${op.name}</td>
            <td>${op.checkedBy}</td>
            <td>${op.mobile}</td>
            <td>${formatDate(op.start)} - ${formatDate(op.end)}</td>
            ${actionsCell}
        `;
        tbody.appendChild(tr);
    });
    
    localStorage.setItem('operators', JSON.stringify(operators));
    populateFilter();
    renderNextShifts(); 
}

function renderNextShifts() {
    const container = document.getElementById('nextShiftsContainer');
    container.innerHTML = '';
    
    if (operators.length === 0) {
        container.innerHTML = '<p style="padding: 0 15px; color:#999;">No schedule data available.</p>';
        return;
    }

    let startIndex = operators.findIndex(op => {
        const opStart = getCleanDate(op.start);
        const opEnd = getCleanDate(op.end);
        return (today.getTime() >= opStart.getTime() && today.getTime() <= opEnd.getTime());
    });
    
    if (startIndex === -1) {
        startIndex = operators.findIndex(op => getCleanDate(op.start).getTime() > today.getTime());
        if (startIndex === -1) startIndex = 0;
    } else {
        startIndex += 1;
    }

    const shiftsToShow = operators.slice(startIndex, startIndex + 5);

    if (shiftsToShow.length === 0) {
        container.innerHTML = '<p style="padding: 0 15px; color:#999;">No upcoming shifts found in the current schedule.</p>';
        return;
    }

    shiftsToShow.forEach(op => {
        const card = document.createElement('div');
        card.className = 'shift-card';
        card.innerHTML = `
            <div class="shift-card-header">${op.name}</div>
            <p>Shift Start: <span class="date-range">${formatDate(op.start)}</span></p>
            <p>Shift End: <span class="date-range">${formatDate(op.end)}</span></p>
        `;
        container.appendChild(card);
    });
}


// --- Admin Actions (Add/Rename/Reset/Delete/ResetAll) ---

function addOperator() {
    if (!isAdmin) return alert('Full Admin privileges required for editing.');
    const name = document.getElementById('operatorName').value.trim().toUpperCase(); 
    const mobile = document.getElementById('mobileNumber').value.trim();
    const startDate = document.getElementById('startDate').value;

    if (!name || !mobile) return alert('Please fill in both Operator Name and Mobile Number.');
    if (!startDate) return alert('Please set the Schedule Start Date at the top.');

    const exists = initialOperators.some(op => op.name.toLowerCase() === name.toLowerCase());
    if (exists) return alert('This operator name already exists.');

    initialOperators.push({ name, mobile });
    localStorage.setItem(INITIAL_OPERATORS_DATA_KEY, JSON.stringify(initialOperators));
    
    if (!operatorPasswords[name]) {
        operatorPasswords[name] = DEFAULT_OPERATOR_PWD;
        localStorage.setItem('operatorPasswords', JSON.stringify(operatorPasswords));
    }
    
    document.getElementById('operatorName').value = '';
    document.getElementById('mobileNumber').value = '';
    
    generateFullSchedule(startDate);
    renderTable();
    alert(`Operator ${name} added. Schedule re-generated for 1 year.`);
}

function resetAll() {
    if (!isAdmin || !confirm('DANGER: This will clear ALL stored operators, passwords, and the entire schedule! Are you absolutely sure?')) return;
    
    localStorage.removeItem('operators');
    localStorage.removeItem('operatorPasswords');
    localStorage.removeItem(INITIAL_OPERATORS_DATA_KEY);
    
    window.location.reload(); 
    alert('All data has been completely wiped and the application reset.');
}

function deleteOperatorShift(globalIndex) {
    if (!isAdmin) return alert('Full Admin privileges required for editing.');
    if (globalIndex < 0 || globalIndex >= operators.length) return alert('Invalid shift selected.');

    const shiftToDelete = operators[globalIndex];
    if (!confirm(`Are you sure you want to delete this shift for ${shiftToDelete.name} (${formatDate(shiftToDelete.start)} - ${formatDate(shiftToDelete.end)})? This will break the rotation.`)) return;

    operators.splice(globalIndex, 1);
    localStorage.setItem('operators', JSON.stringify(operators));
    
    renderTable();
    alert('Shift deleted.');
}

function resetOperatorPassword(globalIndex) {
    if (!isAdmin) return alert('Full Admin privileges required for editing.');
    if (globalIndex < 0 || globalIndex >= operators.length) return alert('Invalid shift selected.');

    const targetOpName = operators[globalIndex].name;
    if (!confirm(`Are you sure you want to reset the password for ${targetOpName} to the default password?`)) return;

    operatorPasswords[targetOpName] = DEFAULT_OPERATOR_PWD;
    localStorage.setItem('operatorPasswords', JSON.stringify(operatorPasswords));
    alert(`Password for ${targetOpName} reset to default.`);
}

// --- Shift Swap Functions ---

function openSwapModal(globalIndex) {
    if (!isAdmin) return alert('Full Admin privileges required for editing.');
    swapTargetGlobalIndex = globalIndex;
    const shift = operators[globalIndex];
    const modal = document.getElementById('swapModal');
    const operatorSelect = document.getElementById('newOperatorSelect');
    
    if (!shift) {
        alert("Invalid shift data.");
        return;
    }

    document.getElementById('swapShiftStart').textContent = formatDate(shift.start);
    document.getElementById('swapCurrentOperator').textContent = shift.name;

    // Populate the dropdown list
    operatorSelect.innerHTML = '';
    initialOperators.forEach(op => {
        // Option to exclude the current operator from the swap list for clarity
        if (op.name !== shift.name) { 
             const option = document.createElement('option');
             option.value = op.name;
             option.textContent = op.name;
             operatorSelect.appendChild(option);
        }
    });

    if (operatorSelect.options.length === 0) {
        alert("Cannot swap: No other operators available.");
        swapTargetGlobalIndex = null;
        return;
    }
    
    modal.style.display = 'block';
}

function closeSwapModal() {
    document.getElementById('swapModal').style.display = 'none';
    swapTargetGlobalIndex = null;
}

function confirmSwap() {
    if (!isAdmin || swapTargetGlobalIndex === null) return;
    
    const newOperatorName = document.getElementById('newOperatorSelect').value;
    const targetShift = operators[swapTargetGlobalIndex];
    
    if (!newOperatorName) {
        alert("Please select a new operator.");
        return;
    }

    const newOperatorDetails = initialOperators.find(op => op.name === newOperatorName);
    if (!newOperatorDetails) {
        alert("Selected operator details not found.");
        return;
    }
    
    // Perform the swap (reassignment)
    targetShift.name = newOperatorDetails.name;
    targetShift.checkedBy = newOperatorDetails.name; 
    targetShift.mobile = newOperatorDetails.mobile;
    
    localStorage.setItem('operators', JSON.stringify(operators));
    renderTable();
    closeSwapModal();
    alert(`Shift for ${formatDate(targetShift.start)} successfully reassigned to ${newOperatorName}.`);
}

// --- PDF Download Function ---

function downloadPdf() {
    if (!loggedInUser) return alert('Please login to download the schedule.');
    
    const scheduleStartDate = document.getElementById('startDate').value;
    const titleDate = formatDate(scheduleStartDate);

    const tableData = operators.map((op, index) => [
        index + 1, 
        op.name,
        op.checkedBy,
        op.mobile,
        `${formatDate(op.start)} - ${formatDate(op.end)}`
    ]);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape'); 

    // Add Title and Header
    doc.setFontSize(18);
    doc.text('Oromia Bank - Backup Operators Schedule', 14, 20);
    doc.setFontSize(12);
    doc.text(`Schedule Generated from: ${titleDate}`, 14, 28);
    doc.text(`Generated by: ${loggedInUser}`, 14, 34);

    // AutoTable configuration
    doc.autoTable({
        startY: 40,
        head: [['S/N', 'Taken by', 'Checked by', 'Mobile number', 'Date Range']],
        body: tableData,
        theme: 'striped',
        headStyles: { 
            fillColor: [148, 200, 61], 
            textColor: 255 
        },
        styles: { fontSize: 10, cellPadding: 3 },
        columnStyles: {
            0: { cellWidth: 15 },
            3: { cellWidth: 40 },
            4: { cellWidth: 70 }
        }
    });

    doc.save('Backup_Operators_Schedule.pdf');
    alert('PDF download initiated.');
}


// --- Other Utility Functions ---

function calculateShiftRange() {
    const startDateString = document.getElementById('calcStartDate').value;
    if (!startDateString) {
        document.getElementById('calcEndDate').textContent = '--';
        document.getElementById('calcWorkingDays').textContent = '--';
        return;
    }
    const startDate = getCleanDate(startDateString);
    const endDate = calculateEndDate(startDate);
    const workingDays = countWorkingDays(startDate, endDate);

    document.getElementById('calcEndDate').textContent = formatDate(endDate);
    document.getElementById('calcWorkingDays').textContent = workingDays;
}

function openRenameModal(globalIndex) {
    if (!isAdmin) return alert('Full Admin privileges required for editing.');
    renameTargetGlobalIndex = globalIndex;
    const shift = operators[globalIndex];

    document.getElementById('newName').value = shift.name;
    document.getElementById('renameModal').style.display = 'block';
}

function closeRenameModal() {
    document.getElementById('renameModal').style.display = 'none';
    renameTargetGlobalIndex = null;
}

function confirmRename() {
    if (!isAdmin || renameTargetGlobalIndex === null) return;
    
    const newName = document.getElementById('newName').value.trim().toUpperCase();
    if (!newName) return alert('Name cannot be empty.');
    
    const oldName = operators[renameTargetGlobalIndex].name;
    
    // 1. Rename the operator in the initial list
    const initialIndex = initialOperators.findIndex(op => op.name === oldName);
    if (initialIndex !== -1) {
        initialOperators[initialIndex].name = newName;
        localStorage.setItem(INITIAL_OPERATORS_DATA_KEY, JSON.stringify(initialOperators));
        
        // Update password keys
        if (operatorPasswords[oldName]) {
            operatorPasswords[newName] = operatorPasswords[oldName];
            delete operatorPasswords[oldName];
            localStorage.setItem('operatorPasswords', JSON.stringify(operatorPasswords));
        }
    }
    
    // 2. Update ALL shifts for this operator in the current schedule
    operators.forEach(op => {
        if (op.name === oldName) {
            op.name = newName;
            op.checkedBy = newName; // Also update the checker name
        }
    });

    localStorage.setItem('operators', JSON.stringify(operators));
    closeRenameModal();
    renderTable();
    alert(`Operator "${oldName}" successfully renamed to "${newName}" throughout the schedule.`);
}

function showDetailModal(op) {
    document.getElementById('detailOperatorName').textContent = op.name;
    document.getElementById('detailMobile').textContent = op.mobile;
    document.getElementById('detailStart').textContent = formatDate(op.start);
    document.getElementById('detailEnd').textContent = formatDate(op.end);
    document.getElementById('detailWorkingDays').textContent = countWorkingDays(op.start, op.end);
    document.getElementById('detailModal').style.display = 'block';
}

function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
}

function openChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'block';
    document.getElementById('newOpPassword').value = '';
    document.getElementById('confirmOpPassword').value = '';
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'none';
}

function confirmPasswordChange() {
    if (!loggedInUser) return alert('You must be logged in to change your password.');

    const newPwd = document.getElementById('newOpPassword').value;
    const confirmPwd = document.getElementById('confirmOpPassword').value;

    if (newPwd !== confirmPwd) {
        alert('New password and confirmation do not match.');
        return;
    }
    if (newPwd.length < 5) {
        alert('Password must be at least 5 characters long.');
        return;
    }
    
    const normalizedUser = loggedInUser.toUpperCase();

    // Admin/Viewer passwords are hardcoded and cannot be changed this way.
    if (loggedInUser === FULL_ADMIN_USER || loggedInUser === RESTRICTED_ADMIN_USER) {
        alert('Admin/Viewer password change is not supported through this interface.');
        closeChangePasswordModal();
        return;
    }
    
    // Handle Operator password change
    operatorPasswords[normalizedUser] = newPwd;
    localStorage.setItem('operatorPasswords', JSON.stringify(operatorPasswords));
    alert('Password changed successfully. Please re-login with the new password.');
    closeChangePasswordModal();
    logout();
}


function resetMyPassword() {
    if (!isOperator || !loggedInUser) return alert('This feature is only for logged-in operators.');

    if (!confirm(`Are you sure you want to reset your own password to the default password? (${DEFAULT_OPERATOR_PWD})`)) return;

    operatorPasswords[loggedInUser] = DEFAULT_OPERATOR_PWD;
    localStorage.setItem('operatorPasswords', JSON.stringify(operatorPasswords));
    alert('Your password has been reset to the default. You will now be logged out. Please re-login.');
    logout();
}

function scrollToAdd() {
    document.getElementById('adminControls').scrollIntoView({ behavior: 'smooth' });
}


// --- Initialize the application on load ---
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
